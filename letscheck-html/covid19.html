<!DOCTYPE html>
<html lang="en">

<head>
  <!--
      Following Google HTML/CSS Style Guide
      https://google.github.io/styleguide/htmlcssguide.html
  -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162059356-2"></script>
  <script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
          dataLayer.push(arguments);
      }

      gtag("js", new Date());

      gtag("config", "UA-162059356-2");
  </script>

  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NUS Centre for Trusted Internet and Community</title>
  <link href="images/favicon.ico" type="image/vnd.microsoft.icon">
  <meta name="keywords"
        content="NUS, CTIC, Centre for Trusted Internet and Community, Internet and trust, Internet and community, Internet and public good, Misinformation, Disinformation, Fake news, Good technology, Digital wellbeing, Digital intelligence"
  />
  <meta name="rights" content="National University of Singapore"/>
  <meta name="description"
        content="NUS Centre for Trusted Internet and Community aims to integrate social and behavioural science research, digital technologies, data-driven approaches, and policy studies to holistically examine the Internet and its societal impact"
  />
  <meta name="google-site-verification" content="BKFQngs3vcAVXTTzeRuXaGvrZmclMGRTgu6cp-MLkvM"/>
  <meta name="google-site-verification" content="QfdfA8xpn-7WYqglaL6eX37WzpsfityDynXflnjqUPw" />
  <link rel="stylesheet" href="css/bootstrap.min.css"/>
  <link rel="stylesheet" href="css/styleguide.css"/>
  <link rel="stylesheet" href="css/template.css"/>
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/searchbar.css">
  <link href="css/newcss.css" rel="stylesheet">
  <link href="css/quin.css" rel="stylesheet">
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/bootstrap.min.js" type="text/javascript"></script>
  <script src="js/jquery.tap.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="js/fancybox-master/dist/jquery.fancybox.min.css"/>
  <script src="js/fancybox-master/dist/jquery.fancybox.min.js"></script>
  <style>
      table,
      th,
      td {
          border: 1px solid black;
      }

      h4 {
          font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
      }

      p {
          color: white;
          border-width: thick;
      }

      h3.page-title {
          padding-top: 0 !important;
          padding-bottom: 5px !important;
      }

      button.choices {
          font-size: 17px;
      }

      .result-container {
          border: 1pt solid #dedede;
          padding-top: 1em;
          padding-bottom: 1em;
      }

  </style>
</head>

<body>
<!-- MENU FOR MOBILE - OFF CANVAS - START -->
<div id="nus-sidebar-off-canvas"
     class="nus-sidebar-off-canvas hidden-lg hidden-md off-canvas-effect-4 off-canvas-right"></div>
<!-- MENU FOR MOBILE	 - OFF CANVAS - END -->

<div class="nus-body-container">
  <div class="nus-wrapper">
    <!-- MENU FOR header - START -->
    <div id="menu-header"></div>
    <!-- MENU FOR header - END -->

    <!-- CONTENT - START -->
    <div class="nus-department-header">
      <div class="orange">
        <!-- change to "blue", "grey", or "orange" to see background color changes -->
        <div class="container">
          <h3 class="page-title"> Let's check COVID-19 Claims </h3>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="featurette-divider"></div>
      <h4>
        The COVID-19 pandemic demonstrates the importance of responsible public discourse. This platform allows you to
        explore claims circulating in Twitter, and you can choose to check against scientific articles or news.
      </h4>
    </div>


    <div class="container">
<!--      <h4> Search from: </h4>-->
      <br/>
      <div class="mb-3" style="display: flex;">
        <input id="active-engine" style="display: none;" value="twitter"/>
        <div class="col-12 col-md-3 mb-2">
          <button id="twitter" onclick="const t = this; onSearchButtonClick(t) && getTwatchApiTwitterResults();"
                  type="submit"
                  class="btn btn-block btn-primary choices">
            Twitter
          </button>
        </div>

        <div class="col-12 col-md-3 mb-2">
          <button id="news" onclick="const n = this; onSearchButtonClick(n) && getQuinApiResultForNewsArticles();"
                  type="submit"
                  class="btn btn-block btn-default choices">
            News
          </button>
        </div>

        <div class="col-12 col-md-3 mb-2">
          <button id="science"
                  onclick="const s = this; onSearchButtonClick(s) && getQuinApiResultForScientificArticles();"
                  type="submit" class="btn btn-block btn-default w-150 choices">
            Scientific articles
          </button>
        </div>
      </div>
      <br/>
      <form onsubmit="return submitQuery();" class="form-inline col-12 col-md-12 my-2 my-lg-2">
        <div class="input-group">
          <input type="text" style="font-size:16px;" size="75" id="query-input" class="form-control bg-white border-1"
                 placeholder="Search for claims (e.g. there is vaccine for COVID)" maxlength="128" value=""
                 spellcheck="true" required><br/>
          <div class="input-group-addon" style="cursor: pointer;">
            <div onclick="submitQuery()"><i class="fa fa-search"></i></div>
          </div>
        </div>
        <br/>
        <span id="query-input-empty-message" style="color:red;"></span>
      </form>
      <br/>
    </div>

    <!-- Scientific Articles and News search results display-->
    <div style="text-align: center;">
      <img id="loading-spinner" src="images/loader-spinner.gif" style="width: 10%; height: 10%; display: none;"
           alt="">
    </div>
    <div class="container" id="search-results" style="display: none; padding-top: 1.5em;">
      <div class="result-container" id="search-results-content" style="display: none;">
      </div>
      <div style="text-align: center;" id="search-count-and-pagination">
        <div id="search-count" style="margin-bottom: -2rem;">
        </div>
        <i>
          <p class="centered" id="search-results-credit" style="text-align: center;margin-top: 1em;">
          </p>
        </i>
      </div>
    </div>
    <div class="container">
      <h4 id="search-error-messages" style="text-align: center; margin: 2em auto; display: none">
      </h4>
    </div>


    <!-- Twatch frame for Twitter search -->
    <!-- hide by default -->
    <div id="twatch-container" style="height: 135vh;padding-top:1em;">
      <div class="container" style="display: none;" id="Twatch-frame-container">
        <iframe id="Twatch-frame" src="" title="Twatch frame"
                style="height: 130vh; width: 100%; border: none; overflow: hidden;">
        </iframe>
      </div>
      <div class="container" style="display: block;" id="trend-frame-container">
        <iframe id="trend-frame" src="https://letscheck.nus.edu.sg/twatch/trend/" title="Trend frame"
                style="height: 75vh; width: 100%; border: none; overflow: hidden;">
        </iframe>
      </div>
    </div>
    <!-- CONTENT - END -->
    <!-- FOOTER - START -->
    <footer class="nus-footer" id="footer" style="position: relative;"></footer>
    <!-- FOOTER - END -->
  </div>
  <!-- NUS WRAPPER -->
</div>
<!-- NUS BODY CONTAINER -->
</body>
<script type="text/javascript" src="js/mobile.js"></script>
<script type="text/javascript">
    $("#menu-header").load("menu/menu-header.html", function () {
        $("#nus-sidebar-off-canvas").ready(function () {
            buildSideBar("#nus-sidebar-off-canvas");

            $.getScript("js/offcanvas.js");
            $.getScript("js/common.js");
        })

    });
    $("#footer").load("menu/footer.html");
</script>
<script>
    /** Displays the spinner while searching for Scientific Articles or News. */
    function displayLoadingSpinner() {
        document.getElementById("loading-spinner").style.display = "inline-block";
    }

    /** Hides the spinner after searching for Scientific Articles or News. */
    function hideLoadingSpinner() {
        document.getElementById("loading-spinner").style.display = "none";
    }
</script>
<script>
    /** Handles no results found when searching */

    function showSearchErrorMessages() {
        const searchWord = document.getElementById("query-input").value;
        let searchWordDisplay = `"${searchWord}"`;
        if (searchWord === "") {
            searchWordDisplay = "empty";
        }
        document.getElementById("search-error-messages").innerHTML =
            `<br>
            <i class="fa fa-info-circle"></i>  Sorry, we couldn't find any results matching ${searchWordDisplay}. <br><br> Remember to check your spelling and use the search term "COVID-19" for more accurate results. `
    }

    function removeFetchErrorMessages() {
        document.getElementById("search-error-messages").innerHTML = ``;
    }
</script>
<style>
    #rtypes {
        margin-bottom: 1.5em;
    }

    .rtype {
        padding: 0.5em;
        cursor: pointer;
    }

    #search-results-content-items {
        height: 75vh;
        overflow-y: scroll;
    }
</style>
<script type="text/javascript">
    /** Colors of veracity ratings */
    const veracityColors = {
        "Probably True": "darkgreen",
        "Probably False": "darkred",
        "? Ambiguous": "#885417",
        "Not enough evidence": "#616161",
    }

    const veracityBefore = {
        "Probably True": "✔ ",
        "Probably False": "✘ ",
        "? Ambiguous": "",
        "Not enough evidence": "",
    }

    FETCH_TIME_OUT_MILISECONDS = 30000;

    const showTab = (clicked, showClassName) => {
        console.log(clicked);
        $('.rtype').removeClass('selected');
        $(clicked).addClass('selected');
        $('.result').hide();
        $(showClassName).show();
    }

    const resultTabs = (numAll, numSupporting, numRefuting) => (
        `
         <div id="rtypes" class="centered" style="display: block;">
           <span class="rtype selected" id="r_all" onclick="showTab(this, '.result')">all (${numAll})</span>
           <span class="rtype" id="r_supporting" onclick="showTab(this, '.entailment')">✔ supporting (${numSupporting})</span>
           <span class="rtype" id="r_refuting" onclick="showTab(this, '.contradiction')">✘ refuting (${numRefuting})</span>
         </div>
        `);

    const displayVeracityRating = (veracityRating) => (
        `
        <div class="veracity-rating" style="text-align: center; font-size: 20pt; margin-bottom: 0.3em;">
          Veracity rating:
            <span style="font-weight: bold; color:${veracityColors[veracityRating]}">
              ${veracityBefore[veracityRating] + veracityRating}
            </span>
        </div>
        <p style="text-align: center; color: #212121; margin-bottom: 1.5em; font-size: 10pt;">
          Disclaimer: The veracity rating is still experimental and it is based on evidence from articles.<br/>
          For more reliable fact-checks you can refer to <a href="https://en.wikipedia.org/wiki/List_of_fact-checking_websites">fact-checking organizations</a>.
        </p>
        `);

    /** Cleans the search input query */
    function parseQueryInput(sentence) { // remove space and replace by "%20" for search query
        const words = sentence.split(" ").filter(word => word.length > 0); // remove empty spaces, commas, etc.
        const spaceCharacter = "%20";
        return words.join(spaceCharacter);
    }

    /** Removes current search data when initiating a new search */
    function removeSearchData() {
        document.getElementById("search-results").style.display = "none";
        document.getElementById("search-results-content").innerHTML = ``;
        document.getElementById("search-results-content").style.display = "none";
        document.getElementById("search-results-credit").innerHTML = ``;
        document.getElementById("search-results-credit").style.display = "none";
    }

    /** Removes trend frame when initiating a new search */
    function closeTrendFrame() {
        document.getElementById("trend-frame").src = ``;
        document.getElementById("trend-frame-container").style.display = "none";
    }

    /** Removes Twatch frame when initiating a new search */
    function closeTwatchFrame() {
        document.getElementById("Twatch-frame").src = ``;
        document.getElementById("Twatch-frame-container").style.display = "none";
    }

    /** Shows the search results */
    function activateSearchContent() {
        document.getElementById("search-results").style.display = "block";
        document.getElementById("search-count").style.display = "inline";
        document.getElementById("search-results-content").style.display = "block";
        document.getElementById("search-results-credit").style.display = "block";
        $('.result').show();
    }

    /** Removes previous Quinn results when initiating a new search */
    function removePreviousQuinnResults() {
        closeTrendFrame();
        closeTwatchFrame();
        removeSearchData();
        removeFetchErrorMessages();
    }

    /** Removes previous results when initiating a new Twatch search */
    function removePreviousResultsForTwatch() {
        hideLoadingSpinner();
        deactivateSearchContent();
        removeFetchErrorMessages();
    }

    /** Removes/hides the search results */
    function deactivateSearchContent() {
        document.getElementById("search-results-content").style.display = "none";
        document.getElementById("search-results-credit").style.display = "none";
    }

    /** Executes the action  {@code promise} after {@code seconds} of timeout */
    function timeOut(seconds, promise) {
        return new Promise(function (resolve, reject) {
            setTimeout(function () {
                reject(new Error("timeout"))
            }, seconds)
            promise.then(resolve, reject)
        })
    }

    /** After button is clicked, it's not allowed to be reclicked until the search results are out */
    function onSearchButtonClick(button) {
        const allButtons = $('button.choices')
        allButtons.addClass('btn-default');
        allButtons.removeClass('btn-primary');
        $(button).addClass('btn-primary');
        $(button).removeClass('btn-default');
        $('#active-engine')[0].value = button.id;
        return checkQueryInput();
    }

    /** Submit the search query using the selected option */
    function submitQuery() {
        const activeEngine = $('#active-engine')[0].value;
        if (activeEngine === 'twitter') {
            checkQueryInput() && getTwatchApiTwitterResults();
        } else if (activeEngine === 'news') {
            checkQueryInput() && getQuinApiResultForNewsArticles();
        } else if (activeEngine === 'science') {
            checkQueryInput() && getQuinApiResultForScientificArticles();
        }
        return false;
    }

    /** Fetches results from Quinn API for Scientific Articles and displays it */
    function getQuinApiResultForScientificArticles() {
        removePreviousQuinnResults();
        displayLoadingSpinner();
        document.getElementById("search-error-messages").style.display = "block";
        const searchWord = parseQueryInput(document.getElementById("query-input").value);
        const apiUrl = `https://letscheck.nus.edu.sg/quin/api?source=cord&query=${searchWord}`;

        timeOut(FETCH_TIME_OUT_MILISECONDS, fetch(apiUrl)).then(response => {
            return response.json();
        }).then(response => {
            const numberOfResults = response.data.results.length;
            if (numberOfResults === 0) {
                throw Error;
            }

            const numSupporting = response.data.results.filter(r => r.nli_class === "entailment").length
            const numRefuting = response.data.results.filter(r => r.nli_class === "contradiction").length
            const veracityRating = response.data.veracity_rating;

            hideLoadingSpinner();
            if (veracityRating) {
                document.getElementById("search-results-content").innerHTML += displayVeracityRating(veracityRating);
                // Don't show because the number of evidences looks weird
                // document.getElementById("search-results-content").innerHTML += resultTabs(numberOfResults, numSupporting, numRefuting);
            }


            document.getElementById("search-results-content").innerHTML += `<div id="search-results-content-items"></div>`
            for (i = 0; i < numberOfResults; i++) {
                const currentSource = response.data.results[i];
                const title = currentSource.title;
                const url = currentSource.url;
                const snippet = currentSource.snippet;
                const authors = currentSource.authors;
                const journal = currentSource.journal;
                const nli_class = currentSource.nli_class;

                document.getElementById("search-results-content-items").innerHTML +=
                    `<div class="result ${nli_class}" style="border-style: solid; border-width: thin; background-color: #fcfcfc; display: none;" id="item${i}">
                        <div class = "title"> 
                            <a href = ${url} target = "-blank" style = "font-size: 17px; color: #2196F3;"> 
                                ${title} 
                            </a>
                        </div> 
                        
                        <span class = "text" style="font-size: 14px;"> 
                            ...${snippet} ...
                        </span><br><br>
                        
                        <div class="gray small" style="font-size: 14px;">
                            ${authors}.
                            &nbsp;·&nbsp;${journal}
                        </div> 
                    `;
                document.getElementById("search-results-content-items").innerHTML += `
                    <div class="result line-break ${nli_class}" style="height: 1em;">
                        <br><br>
                    </div>    
                    `;
            }

            const RESULTS_NOTE =
                `<small style="font-size: 13px; color: black;">
                    The results are provided by <a href="https://quin.algoprog.com/">Quin</a>, a project by <a href="https://algoprog.com">Chris Samarinas</a>, <a href="https://www.comp.nus.edu.sg/~whsu/">Wynne Hsu</a>, <a href="https://www.comp.nus.edu.sg/~leeml/">Lee Mong Li</a>.
                </small>
                <br>`;

            document.getElementById("search-results-credit").innerHTML += RESULTS_NOTE;
            activateSearchContent();
            // updatePageItems(FIRST_PAGE);
        }).catch(err => {
            hideLoadingSpinner();
            showSearchErrorMessages();
            console.log(err);
        });
    }

    /** Fetches results from Quinn API for News and displays it. The method is almost the same
     but the apiUrl and response content */
    function getQuinApiResultForNewsArticles() {
        removePreviousQuinnResults();
        displayLoadingSpinner();
        document.getElementById("search-error-messages").style.display = "block";

        const searchWord = parseQueryInput(document.getElementById("query-input").value);
        const apiUrl = `https://letscheck.nus.edu.sg/quin/api?source=news&query=${searchWord}`;

        timeOut(FETCH_TIME_OUT_MILISECONDS, fetch(apiUrl)).then(response => {
            return response.json();
        }).then(response => {
            const numberOfResults = response.data.results.length;
            if (numberOfResults === 0) {
                throw Error;
            }
            const numSupporting = response.data.results.filter(r => r.nli_class === "entailment").length
            const numRefuting = response.data.results.filter(r => r.nli_class === "contradiction").length
            const veracityRating = response.data.veracity_rating;
            hideLoadingSpinner();
            if (veracityRating) {
                document.getElementById("search-results-content").innerHTML += displayVeracityRating(veracityRating);
                // Don't show because the number of evidences looks weird
                // document.getElementById("search-results-content").innerHTML += resultTabs(numberOfResults, numSupporting, numRefuting);
            }

            document.getElementById("search-results-content").innerHTML += `<div id="search-results-content-items"></div>`
            for (i = 0; i < numberOfResults; i++) {
                const currentSource = response.data.results[i];
                const title = currentSource.title;
                const url = currentSource.url;
                const snippet = currentSource.snippet;
                const date = currentSource.date;
                const nli_class = currentSource.nli_class;

                document.getElementById("search-results-content-items").innerHTML +=
                    `<div class="result ${nli_class}" style="border-style: solid; border-width: thin; background-color: #fcfcfc; display: none;" id="item${i}">
                        <div class = "title"> 
                            <a href = ${url} target = "-blank" style = "font-size: 17px; color: #2196F3;"> 
                                ${title} 
                            </a>
                        </div> 
                        
                        <span class = "text" style="font-size: 14px;"> 
                            ...${snippet} ...
                        </span><br><br>
                        
                        <div class="gray small" style="font-size: 14px;">
                          ${date}
                        </div> 
                    `;
                document.getElementById("search-results-content-items").innerHTML += `
                    <div class="result line-break ${nli_class}" style="height: 1em;">
                        <br><br>
                    </div>    
                    `;
            }

            const RESULTS_NOTE =
                `<small style="font-size: 13px; color: black;">
                    The results are provided by <a href="https://quin.algoprog.com/">Quin</a>, a project by <a href="https://algoprog.com">Chris Samarinas</a>, <a href="https://www.comp.nus.edu.sg/~whsu/">Wynne Hsu</a>, <a href="https://www.comp.nus.edu.sg/~leeml/">Lee Mong Li</a>.
                </small>
                <br>`;

            document.getElementById("search-results-credit").innerHTML += RESULTS_NOTE;
            activateSearchContent();
            // updatePageItems(FIRST_PAGE);
        }).catch(err => {
            hideLoadingSpinner();
            showSearchErrorMessages();
            console.log(err);
        });
    }

    /** Fetches and displays search results in Twatch frame */
    function getTwatchApiTwitterResults() {
        closeTrendFrame();
        removePreviousResultsForTwatch();
        document.getElementById("search-error-messages").style.display = "none";
        const searchWord = parseQueryInput(document.getElementById("query-input").value);
        document.getElementById("Twatch-frame").src = `https://letscheck.nus.edu.sg/twatch/search?q=${searchWord}`;

        let TIME_OUT_TO_SHOW_FRAME = 500;
        setTimeout(function () {
            document.getElementById("Twatch-frame-container").style.display = "block";
        }, TIME_OUT_TO_SHOW_FRAME);
    }

    function checkQueryInput() {
        const f = document.getElementById("query-input");
        const m = document.getElementById("query-input-empty-message");
        let query = f.value.toLocaleLowerCase();
        const filteredList = ['covid', 'coronavirus', 'corona', 'virus']
        filteredList.forEach(w => {
            query = query.replaceAll(w, '')
        })

        query = query.replace(/\s\s+/g, ' ');
        query = query.replace(/[^a-zA-Z]/g, ' ');
        query = query.trim();

        if (!f.checkValidity()) {
            f.focus();
            m.textContent = 'Please enter your search query here.';
            return false;
        }

        if (query === '') {
            f.focus();
            m.textContent = 'Please type in a claim or a sentence.';
            return false;
        }

        m.textContent = "";
        return true;
    }


</script>

</html>

